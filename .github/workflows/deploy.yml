name: üöÄ Deploy to Arweave

on:
  workflow_run:
    workflows: ["Auto-merge Agent PRs"]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      message:
        description: 'Deployment message'
        required: false
        type: string
        default: 'Manual deployment via GitHub Actions'

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if the auto-merge workflow succeeded or manual trigger
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone - we use hash-based change detection

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Configure environment from GitHub Secrets
        env:
          ANT_PROCESS_ID: ${{ secrets.ANT_PROCESS_ID }}
          OWNER_ARNS_NAME: ${{ secrets.OWNER_ARNS_NAME }}
          WALLET_ADDRESS: ${{ secrets.WALLET_ADDRESS }}
          ARWEAVE_JWK_JSON: ${{ secrets.ARWEAVE_JWK_JSON }}
          TURBO_PAYMENT_SERVICE_URL: ${{ secrets.TURBO_PAYMENT_SERVICE_URL }}
          TURBO_UPLOAD_SERVICE_URL: ${{ secrets.TURBO_UPLOAD_SERVICE_URL }}
          APP_NAME: RemoteAgentDeploy
        run: |
          echo "Environment configured."

      - name: Prepare Deployment
        id: prepare-deployment
        run: |
          echo "üöÄ Preparing deployment for apps/ changes..."
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üìù Manual trigger detected - deploying all apps"
            echo "message=${{ github.event.inputs.message }}" >> $GITHUB_OUTPUT
          else
            echo "üîÑ Auto-triggered by merge with apps/ changes"
            echo "message=Auto-deployed after merge with apps/ changes" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Arweave
        id: deploy
        env:
          ANT_PROCESS_ID: ${{ secrets.ANT_PROCESS_ID }}
          OWNER_ARNS_NAME: ${{ secrets.OWNER_ARNS_NAME }}
          WALLET_ADDRESS: ${{ secrets.WALLET_ADDRESS }}
          ARWEAVE_JWK_JSON: ${{ secrets.ARWEAVE_JWK_JSON }}
          TURBO_PAYMENT_SERVICE_URL: ${{ secrets.TURBO_PAYMENT_SERVICE_URL }}
          TURBO_UPLOAD_SERVICE_URL: ${{ secrets.TURBO_UPLOAD_SERVICE_URL }}
          APP_NAME: RemoteAgentDeploy
        run: |
          echo "üöÄ Deploying apps after merge with apps/ changes..."
          echo "üí¨ Message: ${{ steps.prepare-deployment.outputs.message }}"
          
          # Initialize deployment tracking
          DEPLOYMENT_SUCCESS=true
          DEPLOYMENT_ERRORS=""
          echo "deployed=false" >> $GITHUB_OUTPUT
          
          # Deploy all apps using incremental detection
          echo "üì± Deploying all apps using incremental detection..."
          find apps/ -type d -mindepth 1 -maxdepth 1 | while read -r app_dir; do
            app_name=$(basename "$app_dir")
            echo "üìÅ Deploying app: $app_name"
            if ! node deploy.js --file "$app_dir" --message "${{ steps.prepare-deployment.outputs.message }}"; then
              DEPLOYMENT_SUCCESS=false
              DEPLOYMENT_ERRORS="$DEPLOYMENT_ERRORS\n‚ùå Failed to deploy app: $app_name"
            fi
          done
          
          # Report deployment results
          if [ "$DEPLOYMENT_SUCCESS" = "true" ]; then
            echo "‚úÖ All deployments completed successfully!"
            echo "deployed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Some deployments failed:"
            echo -e "$DEPLOYMENT_ERRORS"
            exit 1
          fi

      - name: Commit deployment logs and manifests
        if: always()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add deployment logs if they exist
          if [ -f "logs/deployments.json" ]; then
            git add logs/
          fi
          
          # Add deployment tracker files and manifests from all apps
          find apps/ -name "deployment-tracker.json" -o -name "manifest.json" | while read -r file; do
            if [ -f "$file" ]; then
              git add "$file"
            fi
          done
          
          # Commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "Update deployment logs and manifests" || echo "No changes to commit"
            git push origin main || echo "Nothing to push"
          else
            echo "No changes to commit"
          fi

      - name: Trigger Announce Workflow
        if: success() && steps.deploy.outputs.deployed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            console.log('üì¢ Triggering announce workflow...');
            
            // Get the deployment hash from logs
            const fs = require('fs');
            let deploymentHash = '';
            let filePath = 'deploy/hello-world.txt';
            
            try {
              if (fs.existsSync('logs/deployments.json')) {
                const logs = JSON.parse(fs.readFileSync('logs/deployments.json', 'utf8'));
                const latest = logs[logs.length - 1];
                if (latest && latest.success && (latest.undername || latest.commitHash)) {
                  deploymentHash = latest.undername || latest.commitHash;
                  filePath = latest.filePath || 'deploy/hello-world.txt';
                }
              }
            } catch (e) {
              console.log('‚ö†Ô∏è Could not read deployment logs:', e.message);
            }
            
            if (deploymentHash) {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'announce.yml',
                ref: 'main',
                inputs: {
                  deployment_hash: deploymentHash,
                  file_path: filePath,
                  announce_type: 'discord',
                  custom_message: 'Auto-announced after successful deployment'
                }
              });
              console.log('‚úÖ Announce workflow triggered successfully with hash:', deploymentHash);
            } else {
              console.log('‚ö†Ô∏è No deployment hash found, skipping announce trigger');
            }
name: ðŸš€ Deploy to Arweave

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      file_path:
        description: 'File to deploy (e.g., index.html, hello-world.txt)'
        required: true
        type: string
        default: 'index.html'
      message:
        description: 'Deployment message'
        required: false
        type: string
        default: 'Deployed via GitHub Actions'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Configure environment from GitHub Secrets
        env:
          ANT_PROCESS_ID: ${{ secrets.ANT_PROCESS_ID }}
          OWNER_ARNS_NAME: ${{ secrets.OWNER_ARNS_NAME }}
          WALLET_ADDRESS: ${{ secrets.WALLET_ADDRESS }}
          ARWEAVE_JWK_JSON: ${{ secrets.ARWEAVE_JWK_JSON }}
          TURBO_PAYMENT_SERVICE_URL: ${{ secrets.TURBO_PAYMENT_SERVICE_URL }}
          TURBO_UPLOAD_SERVICE_URL: ${{ secrets.TURBO_UPLOAD_SERVICE_URL }}
          APP_NAME: RemoteAgentDeploy
        run: |
          echo "Environment configured."

      - name: Deploy to Arweave
        env:
          ANT_PROCESS_ID: ${{ secrets.ANT_PROCESS_ID }}
          OWNER_ARNS_NAME: ${{ secrets.OWNER_ARNS_NAME }}
          WALLET_ADDRESS: ${{ secrets.WALLET_ADDRESS }}
          ARWEAVE_JWK_JSON: ${{ secrets.ARWEAVE_JWK_JSON }}
          TURBO_PAYMENT_SERVICE_URL: ${{ secrets.TURBO_PAYMENT_SERVICE_URL }}
          TURBO_UPLOAD_SERVICE_URL: ${{ secrets.TURBO_UPLOAD_SERVICE_URL }}
          APP_NAME: RemoteAgentDeploy
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ðŸš€ Manual deployment triggered"
            npm run deploy -- --file "${{ github.event.inputs.file_path }}" --message "${{ github.event.inputs.message }}"
          else
            echo "ðŸš€ Automatic deployment triggered by push to main"
            npm run deploy -- --file "hello-world.txt" --message "Auto-deployed after merge to main"
          fi

      - name: Commit deployment logs
        if: always()
        run: |
          if [ -f "logs/deployments.json" ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add logs/
            git commit -m "Update deployment logs" || echo "No changes to commit"
            git push origin main || echo "Nothing to push"
          fi
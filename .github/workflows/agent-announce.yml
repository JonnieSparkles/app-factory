name: Agent Twitter Announcement

on:
  workflow_dispatch:
    inputs:
      deployment_hash:
        description: 'Deployment hash/undername to announce'
        required: true
        type: string
      file_path:
        description: 'File that was deployed'
        required: false
        type: string
        default: 'hello-world.txt'

jobs:
  announce:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Announce on Twitter
        env:
          ANT_PROCESS_ID: ${{ secrets.ANT_PROCESS_ID }}
          OWNER_ARNS_NAME: ${{ secrets.OWNER_ARNS_NAME }}
          WALLET_ADDRESS: ${{ secrets.WALLET_ADDRESS }}
          ARWEAVE_JWK_JSON: ${{ secrets.ARWEAVE_JWK_JSON }}
          TWITTER_APP_KEY: ${{ secrets.TWITTER_APP_KEY }}
          TWITTER_APP_SECRET: ${{ secrets.TWITTER_APP_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          # Create deployment data for the announcement
          node -e "
          const { postTemplateAnnouncement } = require('./lib/twitter.js');
          
          const deploymentData = {
            success: true,
            undername: '${{ github.event.inputs.deployment_hash }}',
            commitHash: '${{ github.event.inputs.deployment_hash }}',
            filePath: '${{ github.event.inputs.file_path }}',
            txId: 'github-action-${{ github.run_id }}',
            fileSize: 0,
            duration: 0
          };
          
          postTemplateAnnouncement(deploymentData, true)
            .then(result => {
              if (result.success) {
                console.log('‚úÖ Twitter announcement posted successfully');
                console.log('üê¶ Tweet posted with hash: ${{ github.event.inputs.deployment_hash }}');
              } else {
                console.log('‚ùå Twitter announcement failed:', result.error || result.reason);
                process.exit(1);
              }
            })
            .catch(error => {
              console.error('‚ùå Twitter announcement error:', error.message);
              process.exit(1);
            });
          "

name: Announce Deployment on Twitter

on:
  workflow_dispatch:
    inputs:
      deployment_hash:
        description: 'Deployment hash/undername to announce'
        required: true
        type: string
      custom_message:
        description: 'Custom message (optional)'
        required: false
        type: string
  workflow_run:
    workflows: ["Deploy on push"]
    types: [completed]
    branches: [main]

jobs:
  announce:
    runs-on: ubuntu-latest
    # Only run if the deploy workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Get deployment info
        id: deployment
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "hash=${{ github.event.inputs.deployment_hash }}" >> $GITHUB_OUTPUT
            echo "message=${{ github.event.inputs.custom_message }}" >> $GITHUB_OUTPUT
          else
            # For workflow_run triggers, we need a deployment hash
            echo "hash=" >> $GITHUB_OUTPUT
            echo "message=" >> $GITHUB_OUTPUT
            echo "⚠️ Automatic deployment hash detection not available in workflow_run"
            echo "Please use workflow_dispatch with a specific deployment hash"
          fi

      - name: Announce on Twitter
        if: steps.deployment.outputs.hash != ''
        env:
          ANT_PROCESS_ID: ${{ secrets.ANT_PROCESS_ID }}
          OWNER_ARNS_NAME: ${{ secrets.OWNER_ARNS_NAME }}
          WALLET_ADDRESS: ${{ secrets.WALLET_ADDRESS }}
          ARWEAVE_JWK_JSON: ${{ secrets.ARWEAVE_JWK_JSON }}
          TWITTER_APP_KEY: ${{ secrets.TWITTER_APP_KEY }}
          TWITTER_APP_SECRET: ${{ secrets.TWITTER_APP_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          node scripts/announce.js "${{ steps.deployment.outputs.hash }}" "hello-world.txt"

      - name: Announcement failed
        if: steps.deployment.outputs.hash == ''
        run: |
          echo "❌ No deployment hash found to announce"
          echo "Available options:"
          echo "1. Use workflow_dispatch with a specific hash"
          echo "2. Ensure the deploy workflow completed successfully"
          exit 1

name: ğŸ“¢ Discord Deployment Announcement

on:
  workflow_dispatch:
    inputs:
      deployment_hash:
        description: 'Deployment hash/undername to announce'
        required: true
        type: string
      file_path:
        description: 'File that was deployed'
        required: false
        type: string
        default: 'index.html'
      announce_type:
        description: 'Announcement type (Discord only)'
        required: false
        type: choice
        default: 'discord'
        options:
          - 'discord'
      custom_message:
        description: 'Custom message (optional)'
        required: false
        type: string
      apps_with_changes:
        description: 'Number of apps that had changes (for template selection)'
        required: false
        type: string
        default: '0'
      total_apps:
        description: 'Total number of apps checked'
        required: false
        type: string
        default: '5'

jobs:
  announce:
    runs-on: ubuntu-latest
    # Only run on manual trigger (workflow_dispatch)
    if: ${{ github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: read
    steps:
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for better commit analysis

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ§ª Test Discord Connection
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          echo "ğŸ” Testing Discord webhook connection..."
          if node deploy.js --test-discord; then
            echo "âœ… Discord connection successful"
          else
            echo "âŒ Discord connection failed - skipping announcement"
            exit 0
          fi

      - name: ğŸ“Š Get Deployment Information
        id: deployment
        run: |
          echo "ğŸ” Getting deployment information from workflow inputs..."
          
          echo "hash=${{ github.event.inputs.deployment_hash }}" >> $GITHUB_OUTPUT
          echo "file_path=${{ github.event.inputs.file_path }}" >> $GITHUB_OUTPUT
          echo "message=${{ github.event.inputs.custom_message }}" >> $GITHUB_OUTPUT
          echo "apps_with_changes=${{ github.event.inputs.apps_with_changes }}" >> $GITHUB_OUTPUT
          echo "total_apps=${{ github.event.inputs.total_apps }}" >> $GITHUB_OUTPUT
          echo "trigger=workflow_dispatch" >> $GITHUB_OUTPUT
          
          # Determine announcement type based on whether changes were made
          APPS_WITH_CHANGES=${{ github.event.inputs.apps_with_changes || '0' }}
          if [ "$APPS_WITH_CHANGES" -gt 0 ]; then
            echo "announcement_type=deployment_success" >> $GITHUB_OUTPUT
            echo "ğŸ“¢ Announcement type: Deployment Success (changes detected)"
          else
            echo "announcement_type=no_changes" >> $GITHUB_OUTPUT
            echo "ğŸ“¢ Announcement type: No Changes (all apps up to date)"
          fi
          
          # Try to get manifest TX ID from logs for additional context (only if there were changes)
          if [ "$APPS_WITH_CHANGES" -gt 0 ] && [ -f "logs/deployments.json" ]; then
            MANIFEST_TX_ID=$(node -e "
              const fs = require('fs');
              try {
                const logs = JSON.parse(fs.readFileSync('logs/deployments.json', 'utf8'));
                const latest = logs[logs.length - 1];
                console.log(latest?.manifestTxId || latest?.txId || '');
              } catch (e) {
                console.log('');
              }
            ")
            if [ -n "$MANIFEST_TX_ID" ]; then
              echo "manifest_tx_id=$MANIFEST_TX_ID" >> $GITHUB_OUTPUT
              echo "ğŸ“‹ Found manifest TX ID: $MANIFEST_TX_ID"
            else
              echo "manifest_tx_id=" >> $GITHUB_OUTPUT
            fi
          else
            echo "manifest_tx_id=" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ” Check if deployment occurred
        id: check-deployment
        run: |
          if [ -z "${{ steps.deployment.outputs.hash }}" ]; then
            echo "âš ï¸ No deployment hash found - skipping announcement"
            echo "has_deployment=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… Deployment hash found: ${{ steps.deployment.outputs.hash }}"
            echo "has_deployment=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¢ Announce on Discord
        if: steps.check-deployment.outputs.has_deployment == 'true'
        env:
          ANT_PROCESS_ID: ${{ secrets.ANT_PROCESS_ID }}
          OWNER_ARNS_NAME: ${{ secrets.OWNER_ARNS_NAME }}
          WALLET_ADDRESS: ${{ secrets.WALLET_ADDRESS }}
          ARWEAVE_JWK_JSON: ${{ secrets.ARWEAVE_JWK_JSON }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          TOTAL_APPS: ${{ steps.deployment.outputs.total_apps }}
        run: |
          # Always use Discord announcements
          ANNOUNCE_TYPE="discord"
          
          echo "ğŸ“¢ Sending Discord notification..."
          echo "ğŸ“ File: ${{ steps.deployment.outputs.file_path }}"
          echo "ğŸ”‘ Hash: ${{ steps.deployment.outputs.hash }}"
          echo "ğŸ¯ Trigger: ${{ steps.deployment.outputs.trigger }}"
          echo "ğŸ“Š Apps with changes: ${{ steps.deployment.outputs.apps_with_changes }}"
          echo "ğŸ“Š Total apps: ${{ steps.deployment.outputs.total_apps }}"
          echo "ğŸ“¢ Type: ${{ steps.deployment.outputs.announcement_type }}"
          
          # Use different announcement logic based on whether changes were made
          APPS_WITH_CHANGES=${{ steps.deployment.outputs.apps_with_changes }}
          TOTAL_APPS=${{ steps.deployment.outputs.total_apps }}
          
          if [ "$APPS_WITH_CHANGES" -gt 0 ]; then
            echo "ğŸš€ Sending deployment success notification..."
            if node scripts/discord-announce.js "${{ steps.deployment.outputs.hash }}" "${{ steps.deployment.outputs.file_path }}" "${{ steps.deployment.outputs.manifest_tx_id }}"; then
              echo "âœ… Discord deployment success notification sent!"
            else
              echo "âŒ Discord notification failed"
              exit 1
            fi
          else
            echo "âœ… Sending no-changes notification..."
            # For no-changes, we'll create a simple message without deployment links
            if node scripts/discord-announce.js "no-changes" "all-apps" ""; then
              echo "âœ… Discord no-changes notification sent!"
            else
              echo "âŒ Discord notification failed"
              exit 1
            fi
          fi

      - name: ğŸ“‹ Announcement Summary
        if: always()
        run: |
          echo "ğŸ“Š Announcement Summary:"
          echo "  Trigger: ${{ steps.deployment.outputs.trigger || 'unknown' }}"
          echo "  File: ${{ steps.deployment.outputs.file_path || 'unknown' }}"
          echo "  Hash: ${{ steps.deployment.outputs.hash || 'unknown' }}"
          echo "  Status: ${{ job.status }}"

name: ğŸ¦ Twitter Deployment Announcement

on:
  workflow_dispatch:
    inputs:
      deployment_hash:
        description: 'Deployment hash/undername to announce'
        required: true
        type: string
      file_path:
        description: 'File that was deployed'
        required: false
        type: string
        default: 'index.html'
      custom_message:
        description: 'Custom message (optional)'
        required: false
        type: string
  workflow_run:
    workflows: ["Deploy on push"]
    types: [completed]
    branches: [main]
  push:
    branches: [main]
    paths: ['index.html', 'hello-world.txt']

jobs:
  announce:
    runs-on: ubuntu-latest
    # Only run if the deploy workflow succeeded or manual trigger
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}
    permissions:
      contents: read
    steps:
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for better commit analysis

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ§ª Test Twitter Connection
        env:
          TWITTER_APP_KEY: ${{ secrets.TWITTER_APP_KEY }}
          TWITTER_APP_SECRET: ${{ secrets.TWITTER_APP_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          echo "ğŸ” Testing Twitter API connection..."
          if node deploy.js --test-twitter; then
            echo "âœ… Twitter connection successful"
          else
            echo "âŒ Twitter connection failed - skipping announcement"
            exit 0
          fi

      - name: ğŸ“Š Get Deployment Information
        id: deployment
        run: |
          echo "ğŸ” Determining deployment information..."
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸ“ Manual trigger detected"
            echo "hash=${{ github.event.inputs.deployment_hash }}" >> $GITHUB_OUTPUT
            echo "file_path=${{ github.event.inputs.file_path }}" >> $GITHUB_OUTPUT
            echo "message=${{ github.event.inputs.custom_message }}" >> $GITHUB_OUTPUT
            echo "trigger=manual" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "push" ]; then
            echo "ğŸš€ Push trigger detected"
            # Generate hash from the latest commit
            COMMIT_HASH=$(git rev-parse --short HEAD)
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '\.(html|txt)$' | head -1)
            if [ -z "$CHANGED_FILES" ]; then
              CHANGED_FILES="index.html"
            fi
            echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
            echo "file_path=$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "message=" >> $GITHUB_OUTPUT
            echo "trigger=push" >> $GITHUB_OUTPUT
            echo "ğŸ“ Detected file: $CHANGED_FILES"
            echo "ğŸ”‘ Generated hash: $COMMIT_HASH"
          else
            echo "ğŸ”„ Workflow run trigger detected"
            # For workflow_run, we'll use a generated hash based on the commit
            COMMIT_HASH=$(git rev-parse --short HEAD)
            echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
            echo "file_path=index.html" >> $GITHUB_OUTPUT
            echo "message=" >> $GITHUB_OUTPUT
            echo "trigger=workflow_run" >> $GITHUB_OUTPUT
            echo "ğŸ”‘ Using commit hash: $COMMIT_HASH"
          fi

      - name: ğŸ¦ Announce on Twitter
        if: steps.deployment.outputs.hash != ''
        env:
          ANT_PROCESS_ID: ${{ secrets.ANT_PROCESS_ID }}
          OWNER_ARNS_NAME: ${{ secrets.OWNER_ARNS_NAME }}
          WALLET_ADDRESS: ${{ secrets.WALLET_ADDRESS }}
          ARWEAVE_JWK_JSON: ${{ secrets.ARWEAVE_JWK_JSON }}
          TWITTER_APP_KEY: ${{ secrets.TWITTER_APP_KEY }}
          TWITTER_APP_SECRET: ${{ secrets.TWITTER_APP_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          echo "ğŸ¦ Posting announcement to Twitter..."
          echo "ğŸ“ File: ${{ steps.deployment.outputs.file_path }}"
          echo "ğŸ”‘ Hash: ${{ steps.deployment.outputs.hash }}"
          echo "ğŸ¯ Trigger: ${{ steps.deployment.outputs.trigger }}"
          
          if node scripts/announce.js "${{ steps.deployment.outputs.hash }}" "${{ steps.deployment.outputs.file_path }}"; then
            echo "âœ… Twitter announcement posted successfully!"
          else
            echo "âŒ Twitter announcement failed"
            exit 1
          fi

      - name: ğŸ“‹ Announcement Summary
        if: always()
        run: |
          echo "ğŸ“Š Announcement Summary:"
          echo "  Trigger: ${{ steps.deployment.outputs.trigger || 'unknown' }}"
          echo "  File: ${{ steps.deployment.outputs.file_path || 'unknown' }}"
          echo "  Hash: ${{ steps.deployment.outputs.hash || 'unknown' }}"
          echo "  Status: ${{ job.status }}"
